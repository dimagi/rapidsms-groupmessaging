{% extends base_template %}
{% load report_tags %}

{% block title %}{{ block.super }} Group Messaging{% endblock %}

{% block stylesheets %}
    {{ block.super }}
    <link type="text/css" rel="stylesheet" href="{{ MEDIA_URL }}groupmessaging/stylesheets/groupmessaging.css" />
{% endblock %}

{% block javascripts %}
{{ block.super }}
    <script type="text/javascript">
    $(document).ready(function() {
    $("#msg").keyup(function(){
        var length = $(this).val().length;
       $("#charcount").text(length);
       $("#charcount").toggleClass("char_good", length < 140);
       $("#charcount").toggleClass("char_warning", (length > 140 && length <= 160));
       $("#charcount").toggleClass("char_over", length > 160);
    });
    $("#messageform").submit(function() {
       if ($("#msg").val().length > 160){
           alert("Cannot send message over 160 characters!");
           return false;
       }
    });
    $(".contactselect").change(function(){
        var selectmap = {};
        $(".contactselect").each(function(){
            selectmap[this.name] = $(this).val();
        });
        $.post("{% url ajax_contact_count %}", $("#messageform").serialize(), function(data){
            $("#contactcount").text(data);
        });
    });
    $.post("{% url ajax_contact_count %}", $("#messageform").serialize(), function(data){
            $("#contactcount").text(data);
    });
    });
    </script>
{% endblock %}

{% block content %}
{#    <div class="two-columns topadded">#}
    <div class="module">

    <h2>Group Messaging</h2>

    <form method=post action="" id="messageform">


    {% csrf_token %}
{#    <label for="contact_set">Send Message To:</label>#}
    <table>
    {% for group in contact_fns %}
        <tr>
        <td><label for="select-{{ group.name }}">{{ group.name }}: </label></td>
        <td><select class="contactselect" id="select-{{ group.name }}" name="select-{{ group.name }}">
            <option id="___all" selected=true><b>All</b></option>
            {% for name in group.groups %}
                <option id="group-{{ name|slugify }}" value="{{ name }}">{{ name }}</option>
            {% endfor %}
        </select>
        </td>
        </tr>
    {% endfor %}
    <tr><td>Total:</td> <td><b><span id="contactcount">--</span> people</td></b></tr>
    </table>

{#    <select id="contact_set" name="contact_set">#}
{#        {% for group in contact_fns %}#}
{#        <optgroup label="{{ group.name }}">#}
{#            {% for name in group.groups %}#}
{#            <option id="group-{{ name }}" num-people="{{ group.groups|dict_lookup:name|length }}" value="{{ name }}">{{ name }} ({{ group.groups|dict_lookup:name|length }} people)</option>#}
{#            {% endfor %}#}
{#        </optgroup>#}
{#        {% endfor %}#}
{#    </select>#}
    <label for="msg">Message: (<span id="charcount" class="char_good">0</span> characters of 160 used)</label><br/>
    <textarea name="msg" id="msg" cols=40 rows=4></textarea>
    <br/>
    <input type="submit" id="msgsubmit" value="Send SMS To All Selected Contacts" />
    </form>
    </div>

{% endblock %}